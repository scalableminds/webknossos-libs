version: "2.2"

services:
  # Production
  webknossos:
    build: .
    image: scalableminds/webknossos:${DOCKER_TAG:-master}
    ports:
      - "9000:9000"
    depends_on:
      postgres:
        condition: service_healthy
      fossildb:
        condition: service_healthy
      redis:
        condition: service_healthy
    command:
      - -Dconfig.file=conf/application.conf
      - -Djava.net.preferIPv4Stack=true
      - -Dtracingstore.fossildb.address=fossildb
      - -Dtracingstore.redis.address=redis
      - -Ddatastore.redis.address=redis
      - -Dslick.db.url=jdbc:postgresql://postgres/webknossos
      - -DwebKnossos.sampleOrganization.enabled=true
      # the following lines need to be adapted for non-localhost deployments
      # - -Dhttp.uri=http://example.org:9000
      # - -Dtracingstore.publicUri=http://example.org:9000
      # - -Ddatastore.publicUri=http://example.org:9000
      # the following lines disable the integrated datastore:
      # - -Dplay.modules.enabled-="com.scalableminds.webknossos.datastore.DataStoreModule"
      # - -Dplay.http.router="noDS.Routes"
    volumes:
      - ./binaryData:/webknossos/binaryData
    environment:
      - POSTGRES_URL=jdbc:postgresql://postgres/webknossos
    user: ${USER_UID:-1000}:${USER_GID:-1000}

  # webknossos-datastore:
  #   build: webknossos-datastore
  #   image: scalableminds/webknossos-datastore:${DOCKER_TAG:-master}
  #   ports:
  #     - "9090:9090"
  #   volumes:
  #     - ./binaryData:/webknossos-datastore/binaryData
  #   command:
  #     - -J-Xmx20G
  #     - -J-Xms1G
  #     - -Dconfig.file=conf/standalone-datastore.conf
  #     - -Dhttp.port=9090
  #     - -Dhttp.uri=http://webknossos-datastore:9090
  #     - -Ddatastore.webKnossos.uri=webknossos:9000
  #     - -Ddatastore.redis.address=redis
  #   depends_on:
  #     redis:
  #       condition: service_healthy

  postgres:
    image: postgres:10-alpine
    environment:
      POSTGRES_DB: webknossos
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -h 127.0.0.1 -p 5432"]
      interval: 2s
      timeout: 5s
      retries: 30

  fossildb:
    image: scalableminds/fossildb:master__410
    command:
      - fossildb
      - -c
      - skeletons,skeletonUpdates,volumes,volumeData,volumeUpdates
    user: ${USER_UID:-fossildb}:${USER_GID:-fossildb}

  redis:
    image: redis:5.0
    command:
      - redis-server
    healthcheck:
      test:
        - CMD
        - bash
        - -c
        - "exec 3<> /dev/tcp/127.0.0.1/6379 && echo PING >&3 && head -1 <&3 | grep PONG"
      timeout: 1s
      interval: 5s
      retries: 10
